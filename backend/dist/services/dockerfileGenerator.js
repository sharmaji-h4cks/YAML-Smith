"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DockerfileGenerator = void 0;
class DockerfileGenerator {
    input;
    constructor(input) {
        this.input = input;
    }
    generate() {
        const dockerfile = this.generateDockerfile();
        const dockerignore = this.input.generateDockerignore
            ? this.generateDockerignore()
            : undefined;
        return { dockerfile, dockerignore };
    }
    generateDockerfile() {
        const lines = [];
        // Add header comment
        lines.push(`# Dockerfile for ${this.input.projectName}`);
        lines.push(`# Language: ${this.input.language}`);
        lines.push(`# Generated by DevOps Forge\n`);
        // Add build args
        if (this.input.buildArgs && this.input.buildArgs.length > 0) {
            this.input.buildArgs.forEach((arg) => {
                if (arg.description) {
                    lines.push(`# ${arg.description}`);
                }
                lines.push(`ARG ${arg.name}=${arg.value}`);
            });
            lines.push('');
        }
        // Generate language-specific Dockerfile
        switch (this.input.language) {
            case 'nodejs':
                lines.push(...this.generateNodejsDockerfile());
                break;
            case 'python':
                lines.push(...this.generatePythonDockerfile());
                break;
            case 'go':
                lines.push(...this.generateGoDockerfile());
                break;
            case 'java':
                lines.push(...this.generateJavaDockerfile());
                break;
            case 'rust':
                lines.push(...this.generateRustDockerfile());
                break;
            case 'dotnet':
                lines.push(...this.generateDotnetDockerfile());
                break;
            case 'php':
                lines.push(...this.generatePhpDockerfile());
                break;
            case 'ruby':
                lines.push(...this.generateRubyDockerfile());
                break;
            default:
                throw new Error(`Unsupported language: ${this.input.language}`);
        }
        return lines.join('\n');
    }
    generateNodejsDockerfile() {
        const lines = [];
        const config = this.input.nodejsConfig || {
            version: '20',
            packageManager: 'npm',
            installDevDependencies: false,
            buildScript: undefined,
            startScript: 'start',
            useNodeModulesCache: true,
        };
        const isMultiStage = this.input.multiStage?.enabled !== false;
        if (isMultiStage) {
            // Build stage
            lines.push(`# Build stage`);
            lines.push(`FROM node:${config.version}-${this.getBaseImageVariant()} AS ${this.input.multiStage?.builderStageName || 'builder'}\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Copy package files first for better caching
            if (config.packageManager === 'pnpm') {
                lines.push('# Install pnpm');
                lines.push('RUN npm install -g pnpm\n');
                lines.push('# Copy package files');
                lines.push('COPY package.json pnpm-lock.yaml ./');
            }
            else if (config.packageManager === 'yarn') {
                lines.push('# Copy package files');
                lines.push('COPY package.json yarn.lock ./');
            }
            else {
                lines.push('# Copy package files');
                lines.push('COPY package.json package-lock.json* ./');
            }
            lines.push('');
            // Install dependencies
            lines.push('# Install dependencies');
            if (config.useNodeModulesCache) {
                lines.push('# Using cache mount for faster builds');
                lines.push(`RUN --mount=type=cache,target=/root/.${config.packageManager} \\`);
                if (config.packageManager === 'npm') {
                    lines.push('    npm ci --only=production');
                }
                else if (config.packageManager === 'yarn') {
                    lines.push('    yarn install --frozen-lockfile --production');
                }
                else {
                    lines.push('    pnpm install --frozen-lockfile --prod');
                }
            }
            else {
                if (config.packageManager === 'npm') {
                    lines.push('RUN npm ci --only=production');
                }
                else if (config.packageManager === 'yarn') {
                    lines.push('RUN yarn install --frozen-lockfile --production');
                }
                else {
                    lines.push('RUN pnpm install --frozen-lockfile --prod');
                }
            }
            lines.push('');
            // Copy application files
            lines.push('# Copy application files');
            lines.push('COPY . .');
            lines.push('');
            // Build if needed
            if (config.buildScript) {
                lines.push('# Build application');
                lines.push(`RUN ${config.packageManager} run ${config.buildScript}`);
                lines.push('');
            }
            // Runtime stage
            lines.push(`# Runtime stage`);
            if (this.input.multiStage?.useDistrolessRuntime) {
                lines.push(`FROM gcr.io/distroless/nodejs${config.version.split('.')[0]}-debian11 AS ${this.input.multiStage?.runtimeStageName || 'runtime'}\n`);
            }
            else {
                lines.push(`FROM node:${config.version}-${this.getBaseImageVariant()} AS ${this.input.multiStage?.runtimeStageName || 'runtime'}\n`);
            }
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Create non-root user
            if (this.input.security?.nonRootUser) {
                this.addNonRootUser(lines);
            }
            // Copy from build stage
            lines.push('# Copy files from build stage');
            lines.push(`COPY --from=${this.input.multiStage?.builderStageName || 'builder'} --chown=${this.input.security?.username || 'appuser'}:${this.input.security?.username || 'appuser'} ${this.input.workdir}/node_modules ./node_modules`);
            lines.push(`COPY --from=${this.input.multiStage?.builderStageName || 'builder'} --chown=${this.input.security?.username || 'appuser'}:${this.input.security?.username || 'appuser'} ${this.input.workdir} ./`);
            lines.push('');
        }
        else {
            // Single stage
            lines.push(`FROM node:${config.version}-${this.getBaseImageVariant()}\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Create non-root user
            if (this.input.security?.nonRootUser) {
                this.addNonRootUser(lines);
            }
            // Copy and install
            lines.push('# Copy package files');
            lines.push('COPY package*.json ./');
            lines.push('');
            lines.push('# Install dependencies');
            lines.push(`RUN ${config.packageManager} ${config.packageManager === 'npm' ? 'ci' : 'install'} --only=production`);
            lines.push('');
            lines.push('# Copy application files');
            lines.push('COPY . .');
            lines.push('');
            if (config.buildScript) {
                lines.push('# Build application');
                lines.push(`RUN ${config.packageManager} run ${config.buildScript}`);
                lines.push('');
            }
        }
        // Add environment variables
        this.addEnvironmentVariables(lines);
        // Switch to non-root user
        if (this.input.security?.nonRootUser) {
            lines.push(`USER ${this.input.security.username || 'appuser'}`);
            lines.push('');
        }
        // Expose port
        if (this.input.port) {
            lines.push(`EXPOSE ${this.input.port}`);
            if (this.input.exposeAdditionalPorts && this.input.exposeAdditionalPorts.length > 0) {
                this.input.exposeAdditionalPorts.forEach((port) => {
                    lines.push(`EXPOSE ${port}`);
                });
            }
            lines.push('');
        }
        // Add health check
        this.addHealthCheck(lines, `node -e "require('http').get('http://localhost:${this.input.port || 3000}/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"`);
        // Add labels
        this.addLabels(lines);
        // Start command
        lines.push('# Start application');
        lines.push(`CMD ["${config.packageManager}", "run", "${config.startScript}"]`);
        return lines;
    }
    generatePythonDockerfile() {
        const lines = [];
        const config = this.input.pythonConfig || {
            version: '3.11',
            packageManager: 'pip',
            requirementsFile: 'requirements.txt',
            useVirtualEnv: true,
            pipUpgrade: true,
        };
        const isMultiStage = this.input.multiStage?.enabled !== false;
        if (isMultiStage) {
            // Build stage
            lines.push(`# Build stage`);
            lines.push(`FROM python:${config.version}-${this.getBaseImageVariant()} AS ${this.input.multiStage?.builderStageName || 'builder'}\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Upgrade pip
            if (config.pipUpgrade) {
                lines.push('# Upgrade pip');
                lines.push('RUN pip install --upgrade pip');
                lines.push('');
            }
            if (config.packageManager === 'poetry') {
                lines.push('# Install Poetry');
                lines.push('RUN pip install poetry');
                lines.push('RUN poetry config virtualenvs.create false');
                lines.push('');
                lines.push('# Copy dependency files');
                lines.push('COPY pyproject.toml poetry.lock* ./');
                lines.push('');
                lines.push('# Install dependencies');
                lines.push('RUN poetry install --no-dev --no-interaction --no-ansi');
            }
            else if (config.packageManager === 'pipenv') {
                lines.push('# Install Pipenv');
                lines.push('RUN pip install pipenv');
                lines.push('');
                lines.push('# Copy dependency files');
                lines.push('COPY Pipfile Pipfile.lock* ./');
                lines.push('');
                lines.push('# Install dependencies');
                lines.push('RUN pipenv install --system --deploy');
            }
            else {
                lines.push('# Copy requirements file');
                lines.push(`COPY ${config.requirementsFile} ./`);
                lines.push('');
                lines.push('# Install dependencies');
                lines.push(`RUN pip install --no-cache-dir -r ${config.requirementsFile}`);
            }
            lines.push('');
            // Copy application files
            lines.push('# Copy application files');
            lines.push('COPY . .');
            lines.push('');
            // Runtime stage
            lines.push(`# Runtime stage`);
            if (this.input.multiStage?.useDistrolessRuntime) {
                lines.push(`FROM gcr.io/distroless/python3-debian11 AS ${this.input.multiStage?.runtimeStageName || 'runtime'}\n`);
            }
            else {
                lines.push(`FROM python:${config.version}-slim AS ${this.input.multiStage?.runtimeStageName || 'runtime'}\n`);
            }
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Create non-root user
            if (this.input.security?.nonRootUser) {
                this.addNonRootUser(lines);
            }
            // Copy from build stage
            lines.push('# Copy Python packages and application from build stage');
            lines.push(`COPY --from=${this.input.multiStage?.builderStageName || 'builder'} /usr/local/lib/python${config.version.split('.').slice(0, 2).join('.')}/site-packages /usr/local/lib/python${config.version.split('.').slice(0, 2).join('.')}/site-packages`);
            lines.push(`COPY --from=${this.input.multiStage?.builderStageName || 'builder'} --chown=${this.input.security?.username || 'appuser'}:${this.input.security?.username || 'appuser'} ${this.input.workdir} ./`);
            lines.push('');
        }
        else {
            // Single stage
            lines.push(`FROM python:${config.version}-${this.getBaseImageVariant()}\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Create non-root user
            if (this.input.security?.nonRootUser) {
                this.addNonRootUser(lines);
            }
            // Upgrade pip
            if (config.pipUpgrade) {
                lines.push('# Upgrade pip');
                lines.push('RUN pip install --upgrade pip');
                lines.push('');
            }
            // Install dependencies
            lines.push('# Copy requirements and install dependencies');
            lines.push(`COPY ${config.requirementsFile} ./`);
            lines.push(`RUN pip install --no-cache-dir -r ${config.requirementsFile}`);
            lines.push('');
            // Copy application
            lines.push('# Copy application files');
            lines.push('COPY . .');
            lines.push('');
        }
        // Add environment variables
        lines.push('# Set Python environment variables');
        lines.push('ENV PYTHONUNBUFFERED=1 \\');
        lines.push('    PYTHONDONTWRITEBYTECODE=1');
        lines.push('');
        this.addEnvironmentVariables(lines);
        // Switch to non-root user
        if (this.input.security?.nonRootUser) {
            lines.push(`USER ${this.input.security.username || 'appuser'}`);
            lines.push('');
        }
        // Expose port
        if (this.input.port) {
            lines.push(`EXPOSE ${this.input.port}`);
            lines.push('');
        }
        // Add health check
        this.addHealthCheck(lines, `python -c "import urllib.request; urllib.request.urlopen('http://localhost:${this.input.port || 8000}/health')"`);
        // Add labels
        this.addLabels(lines);
        // Start command
        lines.push('# Start application');
        lines.push(`CMD ${this.input.startCommand}`);
        return lines;
    }
    generateGoDockerfile() {
        const lines = [];
        const config = this.input.goConfig || {
            version: '1.21',
            useModules: true,
            cgoEnabled: false,
            buildFlags: [],
        };
        const isMultiStage = this.input.multiStage?.enabled !== false;
        if (isMultiStage) {
            // Build stage
            lines.push(`# Build stage`);
            lines.push(`FROM golang:${config.version}-${this.getBaseImageVariant()} AS ${this.input.multiStage?.builderStageName || 'builder'}\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Set Go environment
            lines.push('# Set Go environment');
            lines.push(`ENV CGO_ENABLED=${config.cgoEnabled ? '1' : '0'} \\`);
            lines.push('    GOOS=linux \\');
            lines.push('    GOARCH=amd64');
            lines.push('');
            // Copy go mod files first for better caching
            if (config.useModules) {
                lines.push('# Copy go mod files');
                lines.push('COPY go.mod go.sum ./');
                lines.push('');
                lines.push('# Download dependencies');
                lines.push('RUN --mount=type=cache,target=/go/pkg/mod \\');
                lines.push('    go mod download');
                lines.push('');
            }
            // Copy source code
            lines.push('# Copy source code');
            lines.push('COPY . .');
            lines.push('');
            // Build binary
            lines.push('# Build binary');
            const buildFlags = config.buildFlags && config.buildFlags.length > 0
                ? config.buildFlags.join(' ')
                : '-trimpath';
            const ldflags = config.ldflags || '-s -w';
            lines.push(`RUN --mount=type=cache,target=/go/pkg/mod \\`);
            lines.push(`    --mount=type=cache,target=/root/.cache/go-build \\`);
            lines.push(`    go build ${buildFlags} -ldflags="${ldflags}" -o /app/main .`);
            lines.push('');
            // Runtime stage
            lines.push(`# Runtime stage`);
            if (this.input.multiStage?.useDistrolessRuntime || this.input.baseImageType === 'distroless') {
                lines.push(`FROM gcr.io/distroless/static-debian11 AS ${this.input.multiStage?.runtimeStageName || 'runtime'}\n`);
            }
            else if (this.input.baseImageType === 'scratch') {
                lines.push(`FROM scratch AS ${this.input.multiStage?.runtimeStageName || 'runtime'}\n`);
            }
            else {
                lines.push(`FROM alpine:latest AS ${this.input.multiStage?.runtimeStageName || 'runtime'}\n`);
                lines.push('# Install CA certificates for HTTPS');
                lines.push('RUN apk --no-cache add ca-certificates');
                lines.push('');
            }
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Create non-root user (if not using scratch/distroless)
            if (this.input.security?.nonRootUser && !this.input.baseImageType?.match(/scratch|distroless/)) {
                this.addNonRootUser(lines);
            }
            // Copy binary from build stage
            lines.push('# Copy binary from build stage');
            const chown = this.input.security?.nonRootUser && !this.input.baseImageType?.match(/scratch|distroless/)
                ? `--chown=${this.input.security.username || 'appuser'}:${this.input.security.username || 'appuser'} `
                : '';
            lines.push(`COPY ${chown}--from=${this.input.multiStage?.builderStageName || 'builder'} /app/main ./main`);
            lines.push('');
        }
        else {
            // Single stage (not recommended for Go)
            lines.push(`FROM golang:${config.version}-${this.getBaseImageVariant()}\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            lines.push('# Copy and build');
            lines.push('COPY . .');
            lines.push('RUN go build -o main .');
            lines.push('');
        }
        // Add environment variables
        this.addEnvironmentVariables(lines);
        // Switch to non-root user
        if (this.input.security?.nonRootUser && !this.input.baseImageType?.match(/scratch|distroless/)) {
            lines.push(`USER ${this.input.security.username || 'appuser'}`);
            lines.push('');
        }
        // Expose port
        if (this.input.port) {
            lines.push(`EXPOSE ${this.input.port}`);
            lines.push('');
        }
        // Add health check (if not scratch/distroless)
        if (!this.input.baseImageType?.match(/scratch|distroless/)) {
            this.addHealthCheck(lines, `wget --no-verbose --tries=1 --spider http://localhost:${this.input.port || 8080}/health || exit 1`);
        }
        // Add labels
        this.addLabels(lines);
        // Start command
        lines.push('# Start application');
        lines.push('CMD ["./main"]');
        return lines;
    }
    generateJavaDockerfile() {
        const lines = [];
        const config = this.input.javaConfig || {
            version: '17',
            buildTool: 'maven',
            baseImage: 'eclipse-temurin',
        };
        const isMultiStage = this.input.multiStage?.enabled !== false;
        if (isMultiStage) {
            // Build stage
            lines.push(`# Build stage`);
            if (config.buildTool === 'maven') {
                lines.push(`FROM maven:3.9-${config.baseImage}-${config.version} AS ${this.input.multiStage?.builderStageName || 'builder'}\n`);
            }
            else {
                lines.push(`FROM gradle:8.5-jdk${config.version} AS ${this.input.multiStage?.builderStageName || 'builder'}\n`);
            }
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Copy dependency files first for better caching
            if (config.buildTool === 'maven') {
                lines.push('# Copy pom.xml for dependency resolution');
                lines.push('COPY pom.xml ./');
                lines.push('');
                lines.push('# Download dependencies (cached layer)');
                lines.push('RUN mvn dependency:go-offline -B');
                lines.push('');
            }
            else {
                lines.push('# Copy Gradle files for dependency resolution');
                lines.push('COPY build.gradle settings.gradle gradlew ./');
                lines.push('COPY gradle ./gradle');
                lines.push('');
                lines.push('# Download dependencies (cached layer)');
                lines.push('RUN gradle build -x test --no-daemon || return 0');
                lines.push('');
            }
            // Copy source and build
            lines.push('# Copy source code');
            lines.push('COPY src ./src');
            lines.push('');
            lines.push('# Build application');
            if (config.buildTool === 'maven') {
                lines.push('RUN mvn clean package -DskipTests -B');
            }
            else {
                lines.push('RUN gradle build -x test --no-daemon');
            }
            lines.push('');
            // Runtime stage
            lines.push(`# Runtime stage`);
            lines.push(`FROM ${config.baseImage}:${config.version}-jre AS ${this.input.multiStage?.runtimeStageName || 'runtime'}\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Create non-root user
            if (this.input.security?.nonRootUser) {
                this.addNonRootUser(lines);
            }
            // Copy JAR from build stage
            lines.push('# Copy JAR from build stage');
            const jarPath = config.buildTool === 'maven'
                ? 'target/*.jar'
                : 'build/libs/*.jar';
            const jarName = config.jarName || 'app.jar';
            lines.push(`COPY --from=${this.input.multiStage?.builderStageName || 'builder'} --chown=${this.input.security?.username || 'appuser'}:${this.input.security?.username || 'appuser'} ${this.input.workdir}/${jarPath} ./${jarName}`);
            lines.push('');
        }
        else {
            // Single stage
            lines.push(`FROM ${config.baseImage}:${config.version}-jre\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Create non-root user
            if (this.input.security?.nonRootUser) {
                this.addNonRootUser(lines);
            }
            lines.push('# Copy JAR file');
            lines.push(`COPY ${config.jarName || '*.jar'} ./app.jar`);
            lines.push('');
        }
        // Add environment variables
        this.addEnvironmentVariables(lines);
        // Switch to non-root user
        if (this.input.security?.nonRootUser) {
            lines.push(`USER ${this.input.security.username || 'appuser'}`);
            lines.push('');
        }
        // Expose port
        if (this.input.port) {
            lines.push(`EXPOSE ${this.input.port}`);
            lines.push('');
        }
        // Add health check
        this.addHealthCheck(lines, `curl -f http://localhost:${this.input.port || 8080}/actuator/health || exit 1`);
        // Add labels
        this.addLabels(lines);
        // Start command
        lines.push('# Start application');
        lines.push('CMD ["java", "-jar", "app.jar"]');
        return lines;
    }
    generateRustDockerfile() {
        const lines = [];
        const config = this.input.rustConfig || {
            version: '1.75',
            useMusl: false,
            buildProfile: 'release',
            features: [],
        };
        const isMultiStage = this.input.multiStage?.enabled !== false;
        if (isMultiStage) {
            // Build stage
            lines.push(`# Build stage`);
            lines.push(`FROM rust:${config.version}-${this.getBaseImageVariant()} AS ${this.input.multiStage?.builderStageName || 'builder'}\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Install musl-tools if needed
            if (config.useMusl) {
                lines.push('# Install musl-tools for static linking');
                lines.push('RUN apt-get update && apt-get install -y musl-tools');
                lines.push('RUN rustup target add x86_64-unknown-linux-musl');
                lines.push('');
            }
            // Copy Cargo files first for better caching
            lines.push('# Copy Cargo files');
            lines.push('COPY Cargo.toml Cargo.lock ./');
            lines.push('');
            // Create dummy main to cache dependencies
            lines.push('# Create dummy main.rs to cache dependencies');
            lines.push('RUN mkdir src && echo "fn main() {}" > src/main.rs');
            lines.push('');
            lines.push('# Build dependencies (cached layer)');
            const target = config.useMusl ? ' --target x86_64-unknown-linux-musl' : '';
            lines.push(`RUN cargo build --${config.buildProfile}${target}`);
            lines.push('');
            // Copy real source and build
            lines.push('# Copy source code');
            lines.push('COPY src ./src');
            lines.push('');
            lines.push('# Build application');
            lines.push(`RUN cargo build --${config.buildProfile}${target}`);
            lines.push('');
            // Runtime stage
            lines.push(`# Runtime stage`);
            if (config.useMusl || this.input.baseImageType === 'scratch') {
                lines.push(`FROM scratch AS ${this.input.multiStage?.runtimeStageName || 'runtime'}\n`);
            }
            else if (this.input.multiStage?.useDistrolessRuntime) {
                lines.push(`FROM gcr.io/distroless/cc-debian11 AS ${this.input.multiStage?.runtimeStageName || 'runtime'}\n`);
            }
            else {
                lines.push(`FROM debian:bookworm-slim AS ${this.input.multiStage?.runtimeStageName || 'runtime'}\n`);
            }
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Copy binary from build stage
            lines.push('# Copy binary from build stage');
            const binaryPath = config.useMusl
                ? `target/x86_64-unknown-linux-musl/${config.buildProfile}/${this.input.projectName}`
                : `target/${config.buildProfile}/${this.input.projectName}`;
            lines.push(`COPY --from=${this.input.multiStage?.builderStageName || 'builder'} ${this.input.workdir}/${binaryPath} ./app`);
            lines.push('');
        }
        else {
            // Single stage
            lines.push(`FROM rust:${config.version}-${this.getBaseImageVariant()}\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            lines.push('# Copy and build');
            lines.push('COPY . .');
            lines.push(`RUN cargo build --${config.buildProfile}`);
            lines.push('');
        }
        // Add environment variables
        this.addEnvironmentVariables(lines);
        // Expose port
        if (this.input.port) {
            lines.push(`EXPOSE ${this.input.port}`);
            lines.push('');
        }
        // Add labels
        this.addLabels(lines);
        // Start command
        lines.push('# Start application');
        lines.push('CMD ["./app"]');
        return lines;
    }
    generateDotnetDockerfile() {
        const lines = [];
        const config = this.input.dotnetConfig || {
            version: '8.0',
            configuration: 'Release',
            runtime: 'linux-x64',
        };
        const isMultiStage = this.input.multiStage?.enabled !== false;
        if (isMultiStage) {
            // Build stage
            lines.push(`# Build stage`);
            lines.push(`FROM mcr.microsoft.com/dotnet/sdk:${config.version} AS ${this.input.multiStage?.builderStageName || 'builder'}\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Copy csproj first for better caching
            lines.push('# Copy project file');
            if (config.projectFile) {
                lines.push(`COPY ${config.projectFile} ./`);
            }
            else {
                lines.push('COPY *.csproj ./');
            }
            lines.push('');
            lines.push('# Restore dependencies');
            lines.push('RUN dotnet restore');
            lines.push('');
            // Copy source and build
            lines.push('# Copy source code');
            lines.push('COPY . .');
            lines.push('');
            lines.push('# Build and publish');
            lines.push(`RUN dotnet publish -c ${config.configuration} -o /app/publish --runtime ${config.runtime} --self-contained false`);
            lines.push('');
            // Runtime stage
            lines.push(`# Runtime stage`);
            lines.push(`FROM mcr.microsoft.com/dotnet/aspnet:${config.version} AS ${this.input.multiStage?.runtimeStageName || 'runtime'}\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            // Create non-root user
            if (this.input.security?.nonRootUser) {
                this.addNonRootUser(lines);
            }
            // Copy from build stage
            lines.push('# Copy published app from build stage');
            lines.push(`COPY --from=${this.input.multiStage?.builderStageName || 'builder'} --chown=${this.input.security?.username || 'appuser'}:${this.input.security?.username || 'appuser'} /app/publish ./`);
            lines.push('');
        }
        else {
            // Single stage
            lines.push(`FROM mcr.microsoft.com/dotnet/aspnet:${config.version}\n`);
            lines.push(`WORKDIR ${this.input.workdir}`);
            lines.push('');
            lines.push('# Copy published app');
            lines.push('COPY ./publish ./');
            lines.push('');
        }
        // Add environment variables
        this.addEnvironmentVariables(lines);
        // Switch to non-root user
        if (this.input.security?.nonRootUser) {
            lines.push(`USER ${this.input.security.username || 'appuser'}`);
            lines.push('');
        }
        // Expose port
        if (this.input.port) {
            lines.push(`EXPOSE ${this.input.port}`);
            lines.push('');
        }
        // Add health check
        this.addHealthCheck(lines, `curl -f http://localhost:${this.input.port || 8080}/health || exit 1`);
        // Add labels
        this.addLabels(lines);
        // Start command
        lines.push('# Start application');
        lines.push(`CMD ["dotnet", "${this.input.projectName}.dll"]`);
        return lines;
    }
    generatePhpDockerfile() {
        const lines = [];
        const config = this.input.phpConfig || {
            version: '8.2',
            extensions: [],
            composer: true,
            webServer: 'fpm',
        };
        // Base image with web server variant
        lines.push(`FROM php:${config.version}-${config.webServer}-${this.getBaseImageVariant()}\n`);
        lines.push(`WORKDIR ${this.input.workdir}`);
        lines.push('');
        // Install PHP extensions
        if (config.extensions && config.extensions.length > 0) {
            lines.push('# Install PHP extensions');
            lines.push(`RUN docker-php-ext-install ${config.extensions.join(' ')}`);
            lines.push('');
        }
        // Install Composer
        if (config.composer) {
            lines.push('# Install Composer');
            lines.push('COPY --from=composer:latest /usr/bin/composer /usr/bin/composer');
            lines.push('');
        }
        // Create non-root user
        if (this.input.security?.nonRootUser) {
            this.addNonRootUser(lines);
        }
        // Copy composer files first
        if (config.composer) {
            lines.push('# Copy composer files');
            lines.push('COPY composer.json composer.lock* ./');
            lines.push('');
            lines.push('# Install dependencies');
            lines.push('RUN composer install --no-dev --no-scripts --no-autoloader --prefer-dist');
            lines.push('');
        }
        // Copy application files
        lines.push('# Copy application files');
        lines.push('COPY . .');
        lines.push('');
        // Finalize composer
        if (config.composer) {
            lines.push('# Generate autoloader');
            lines.push('RUN composer dump-autoload --optimize --classmap-authoritative');
            lines.push('');
        }
        // Add environment variables
        this.addEnvironmentVariables(lines);
        // Switch to non-root user
        if (this.input.security?.nonRootUser) {
            lines.push(`USER ${this.input.security.username || 'appuser'}`);
            lines.push('');
        }
        // Expose port
        if (this.input.port) {
            lines.push(`EXPOSE ${this.input.port}`);
            lines.push('');
        }
        // Add health check
        this.addHealthCheck(lines, `php -r "echo 'OK';"`);
        // Add labels
        this.addLabels(lines);
        // Start command based on web server
        lines.push('# Start application');
        if (config.webServer === 'fpm') {
            lines.push('CMD ["php-fpm"]');
        }
        else if (config.webServer === 'apache') {
            lines.push('CMD ["apache2-foreground"]');
        }
        else {
            lines.push(`CMD ["php", "-S", "0.0.0.0:${this.input.port || 8000}", "-t", "public"]`);
        }
        return lines;
    }
    generateRubyDockerfile() {
        const lines = [];
        const config = this.input.rubyConfig || {
            version: '3.2',
            railsEnv: 'production',
        };
        lines.push(`FROM ruby:${config.version}-${this.getBaseImageVariant()}\n`);
        lines.push(`WORKDIR ${this.input.workdir}`);
        lines.push('');
        // Install system dependencies
        lines.push('# Install system dependencies');
        lines.push('RUN apt-get update -qq && apt-get install -y nodejs postgresql-client');
        lines.push('');
        // Create non-root user
        if (this.input.security?.nonRootUser) {
            this.addNonRootUser(lines);
        }
        // Install bundler
        if (config.bundlerVersion) {
            lines.push(`# Install specific Bundler version`);
            lines.push(`RUN gem install bundler -v ${config.bundlerVersion}`);
            lines.push('');
        }
        // Copy Gemfile first
        lines.push('# Copy Gemfile');
        lines.push('COPY Gemfile Gemfile.lock ./');
        lines.push('');
        lines.push('# Install gems');
        lines.push('RUN bundle install --without development test');
        lines.push('');
        // Copy application files
        lines.push('# Copy application files');
        lines.push('COPY . .');
        lines.push('');
        // Precompile assets for Rails
        lines.push('# Precompile assets (Rails)');
        lines.push(`RUN RAILS_ENV=${config.railsEnv} bundle exec rake assets:precompile || true`);
        lines.push('');
        // Add environment variables
        lines.push(`ENV RAILS_ENV=${config.railsEnv} \\`);
        lines.push('    RAILS_LOG_TO_STDOUT=true');
        lines.push('');
        this.addEnvironmentVariables(lines);
        // Switch to non-root user
        if (this.input.security?.nonRootUser) {
            lines.push(`USER ${this.input.security.username || 'appuser'}`);
            lines.push('');
        }
        // Expose port
        if (this.input.port) {
            lines.push(`EXPOSE ${this.input.port}`);
            lines.push('');
        }
        // Add health check
        this.addHealthCheck(lines, `curl -f http://localhost:${this.input.port || 3000}/health || exit 1`);
        // Add labels
        this.addLabels(lines);
        // Start command
        lines.push('# Start application');
        lines.push('CMD ["bundle", "exec", "rails", "server", "-b", "0.0.0.0"]');
        return lines;
    }
    // Helper methods
    getBaseImageVariant() {
        switch (this.input.baseImageType) {
            case 'alpine':
                return 'alpine';
            case 'debian':
                return 'bookworm';
            case 'ubuntu':
                return 'jammy';
            case 'custom':
                return this.input.customBaseImage || 'alpine';
            default:
                return 'alpine';
        }
    }
    addNonRootUser(lines) {
        const username = this.input.security?.username || 'appuser';
        const uid = this.input.security?.uid || 1000;
        const gid = this.input.security?.gid || 1000;
        lines.push('# Create non-root user');
        lines.push(`RUN groupadd -g ${gid} ${username} && \\`);
        lines.push(`    useradd -r -u ${uid} -g ${username} ${username}`);
        lines.push('');
    }
    addEnvironmentVariables(lines) {
        if (this.input.env && this.input.env.length > 0) {
            lines.push('# Set environment variables');
            this.input.env.forEach((envVar, index) => {
                if (index === 0) {
                    lines.push(`ENV ${envVar.name}="${envVar.value}" \\`);
                }
                else if (index === this.input.env.length - 1) {
                    lines.push(`    ${envVar.name}="${envVar.value}"`);
                }
                else {
                    lines.push(`    ${envVar.name}="${envVar.value}" \\`);
                }
            });
            lines.push('');
        }
    }
    addHealthCheck(lines, defaultCommand) {
        if (this.input.healthCheck?.enabled !== false) {
            const config = this.input.healthCheck || {
                enabled: true,
                interval: '30s',
                timeout: '3s',
                startPeriod: '5s',
                retries: 3,
            };
            lines.push('# Health check');
            lines.push('HEALTHCHECK \\');
            lines.push(`    --interval=${config.interval} \\`);
            lines.push(`    --timeout=${config.timeout} \\`);
            lines.push(`    --start-period=${config.startPeriod} \\`);
            lines.push(`    --retries=${config.retries} \\`);
            lines.push(`    CMD ${config.command || defaultCommand || 'exit 0'}`);
            lines.push('');
        }
    }
    addLabels(lines) {
        const allLabels = {
            'maintainer': 'DevOps Forge',
            'org.opencontainers.image.title': this.input.projectName,
            'org.opencontainers.image.description': `${this.input.language} application`,
            'org.opencontainers.image.vendor': 'DevOps Forge',
            ...this.input.labels,
        };
        if (Object.keys(allLabels).length > 0) {
            lines.push('# Labels');
            const entries = Object.entries(allLabels);
            entries.forEach(([key, value], index) => {
                if (index === 0) {
                    lines.push(`LABEL ${key}="${value}" \\`);
                }
                else if (index === entries.length - 1) {
                    lines.push(`      ${key}="${value}"`);
                }
                else {
                    lines.push(`      ${key}="${value}" \\`);
                }
            });
            lines.push('');
        }
    }
    generateDockerignore() {
        const lines = [
            '# Generated by DevOps Forge',
            '',
            '# Git',
            '.git',
            '.gitignore',
            '.gitattributes',
            '',
            '# CI/CD',
            '.github',
            '.gitlab-ci.yml',
            'Jenkinsfile',
            '',
            '# IDE',
            '.vscode',
            '.idea',
            '*.swp',
            '*.swo',
            '*~',
            '',
            '# Documentation',
            '*.md',
            'docs',
            'LICENSE',
            '',
            '# Tests',
            'test',
            'tests',
            '__tests__',
            '*.test.*',
            '*.spec.*',
            'coverage',
            '',
        ];
        // Language-specific ignores
        switch (this.input.language) {
            case 'nodejs':
                lines.push('# Node.js', 'node_modules', 'npm-debug.log', 'yarn-error.log', '.npm', '.yarn', '.pnpm-store', '.env.local', '.env.*.local', 'dist', 'build', '');
                break;
            case 'python':
                lines.push('# Python', '__pycache__', '*.py[cod]', '*$py.class', '*.so', '.Python', 'venv', 'env', '.venv', 'pip-log.txt', '.pytest_cache', '.coverage', 'htmlcov', '*.egg-info', '');
                break;
            case 'go':
                lines.push('# Go', '*.exe', '*.exe~', '*.dll', '*.so', '*.dylib', 'vendor', '');
                break;
            case 'java':
                lines.push('# Java', 'target', '*.class', '*.jar', '*.war', '*.ear', '.gradle', 'build', '');
                break;
            case 'rust':
                lines.push('# Rust', 'target', 'Cargo.lock', '**/*.rs.bk', '');
                break;
            case 'dotnet':
                lines.push('# .NET', 'bin', 'obj', '*.user', '*.suo', '');
                break;
            case 'php':
                lines.push('# PHP', 'vendor', 'composer.lock', '*.log', '');
                break;
            case 'ruby':
                lines.push('# Ruby', '.bundle', 'vendor/bundle', '*.gem', '.env', '');
                break;
        }
        return lines.join('\n');
    }
    validate() {
        const warnings = [];
        const suggestions = [];
        // Check for security issues
        if (!this.input.security?.nonRootUser) {
            warnings.push({
                severity: 'high',
                message: 'Running as root user is a security risk',
                category: 'security',
            });
            suggestions.push('Enable non-root user for better security');
        }
        if (!this.input.multiStage?.enabled) {
            warnings.push({
                severity: 'medium',
                message: 'Multi-stage builds reduce image size significantly',
                category: 'size',
            });
            suggestions.push('Enable multi-stage builds to optimize image size');
        }
        if (!this.input.healthCheck?.enabled) {
            warnings.push({
                severity: 'low',
                message: 'Health checks help Kubernetes/Docker manage container lifecycle',
                category: 'best-practice',
            });
            suggestions.push('Add health check for better container orchestration');
        }
        if (this.input.baseImageType !== 'alpine' && this.input.baseImageType !== 'distroless') {
            warnings.push({
                severity: 'low',
                message: 'Alpine or distroless base images are smaller and more secure',
                category: 'size',
            });
        }
        // Language-specific warnings
        if (this.input.language === 'nodejs') {
            const config = this.input.nodejsConfig;
            if (!config?.useNodeModulesCache) {
                suggestions.push('Enable node_modules caching for faster builds');
            }
        }
        if (this.input.language === 'go') {
            const config = this.input.goConfig;
            if (config?.cgoEnabled) {
                warnings.push({
                    severity: 'medium',
                    message: 'CGO_ENABLED=1 requires C dependencies in runtime image',
                    category: 'size',
                });
            }
        }
        suggestions.push('Build image with: docker build -t ' + this.input.projectName + ' .');
        suggestions.push('Run with: docker run -p ' + (this.input.port || 8080) + ':' + (this.input.port || 8080) + ' ' + this.input.projectName);
        return {
            valid: true,
            warnings,
            suggestions,
        };
    }
}
exports.DockerfileGenerator = DockerfileGenerator;
//# sourceMappingURL=dockerfileGenerator.js.map